{% extends "base.html" %}

{% block title %}{{ user.username }}-HUSTRunner{% endblock %}

{% block page_content %}
<div class="main-content col-md-8">
    <div class="profile-card">
        <div class="profile-main">
            <div class="top">
                <span class="name">{{ user.username }}</span>
            </div>
            <div class="avatar-editor col-md-2">
                <form id="avatar_form" action="/avatar" enctype="multipart/form-data" style="display:none;" method="POST" target="avatar_iframe">
                    <input id="avatar_input" name="picture" type="file" class="file" accept="image/*">
                </form>
                <img src="{{ current_user.avatar }}" class="avatar" data-toggle="tooltip" data-placement="bottom" title="更换头像">
                <iframe id='avatar_iframe' name="avatar_iframe" style="display: none;"></iframe>
            </div>
            <div class="user-describe">
                <div class="short-info">
                {% if user.school %}{<span>{ user.school }}</span>{% endif %}
                {% if user.gender %}<span>{{ user.gender }}</span>{% endif %}
                {% if user.signature %}<span>{{ user.signature }}</span>{% endif %}
                </div>
                <div class="description">
                {% if user.about_me %}<span>{{ user.about_me }}</span>{% endif %}
                </div>
            </div>
        </div>
        <ul class="profile-navbar nav nav-tabs">
            <li><a href="{{ url_for('user.profile', username=user.username) }}"><i class="fa fa-home"></i></a></li>
            <li><a href="{{ url_for('user.posts', username=user.username) }}">文章</a></li>
            <li><a href="{{ url_for('user.comments', username=user.username) }}">回复</a></li>
            <li><a href="#">活动</a></li>
        </ul>
    </div>    
    {% block left_bottom %}{% endblock %}
</div>
<div class="sidebar col-md-4">
    <div class="follow-info">
        <a href="{{ url_for('user.followees', username=user.username) }}">
            <span>关注了</span>
            <br>
            <strong>{{ user.followed.count() }}</strong>
            <label>人</label>
        </a>
        <a href="{{ url_for('user.followers', username=user.username ) }}">
            <span>关注者</span>
            <br>
            <strong>{{ user.followers.count() }}</strong>
            <label>人</label>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    $(function(){
        $('.avatar').click(function(click){
            $('#avatar_input').click();
        });

        $('[data-toggle="tooltip"]').tooltip({
            container: 'body' // http://stackoverflow.com/questions/18194705/display-bootstrap-popovers-outside-divs-with-overflowhidden
        });

        $('input[type=file]').on('change', function(event){
            $('#avatar_form').submit();
        });

        $('#avatar_form').on('submit',(function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            $.ajax({
                type:'POST',
                url: $(this).attr('action'),
                data:formData,
                cache:false,
                contentType: false,
                processData: false,
                success:function(response){
                    $('.avatar, .navbar-avatar').attr('src', response.src);
                },
            });
        }));

    })
</script>
{% endblock %}